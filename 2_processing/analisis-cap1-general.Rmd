---
title: "Código de Análisis de Datos"
output: html_document
---
```{r Ajustes de Markdown,include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = TRUE)
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
rm(list=ls())
options(knitr.kable.NA = '')
```

```{r Cargar paquetes, include=FALSE}
pacman::p_load(ggplot2, #gráficos
               lme4, #multinivel
               texreg, #tabla de regresión
               sjmisc, 
               dplyr,
               sjPlot,
               jtools,
               stargazer,
               webshot) 
```

```{r Cargar base de datos procesada, include=FALSE}
remove(list = ls())
getwd()
load("../1_input/data/procesada/elsoc_barrio.RData")
names(elsoc_barrio)
```

```{r Promedio de SPB x Comuna, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
bar_spb=ggplot(elsoc_barrio, aes(reorder(to_label(comuna), -sentido_pertenencia),sentido_pertenencia))

barras_spb <- 
  bar_spb + geom_bar(stat = "summary") + 
  coord_flip() +
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=10,face="bold")) + 
  labs(x="Comuna", y="Promedio de Sentido de Pertenencia al Barrio por Comuna")

ggsave(barras_spb,filename= "../3_output/graficos/barras_spb.pdf")

barras_spb
```

```{r Boxplot SPB x Comuna, echo=FALSE}
box_spb= ggplot(elsoc_barrio, aes(reorder(to_label(comuna), -sentido_pertenencia),sentido_pertenencia)) 

boxplot_spb <-
  box_spb + geom_boxplot() +  
  coord_flip() + 
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=10,face="bold")) + 
  labs(x="Comuna", y="Promedio de Sentido de Pertenencia al Barrio por Comuna")

ggsave(boxplot_spb,filename= "../3_output/graficos/boxplot_spb.pdf")

boxplot_spb
```
```{r Scatter SPB y Reputación por comuna}
names(elsoc_barrio)
comuna_scat <- elsoc_barrio %>% group_by(comuna) %>% dplyr::select(sentido_pertenencia,rep_barrial,ptj_violencia,servicios_publicos,densidad) %>% summarise_all(mean)

scat_spb_rb <- 
  plot_scatter(comuna_scat,rep_barrial,sentido_pertenencia,
            dot.labels = to_label(comuna_scat$comuna),
            fit.line = "lm",
            show.ci = TRUE,
            title = "Gráfico de dispersión para los promedios de Sentido de Pertenencia y Reputación Barrial agrupados por Comuna",
            axis.titles = c("Promedio de Reputación Barrial por Comuna","Promedio de Sentido de Pertenencia al Barrio por Comuna"))

ggsave(scat_spb_rb,filename= "../3_output/graficos/scat_spb_rb.pdf")

scat_spb_rb
```

```{r Scatter SPB y ptj de Violencia}
scat_spb_pv <-
  plot_scatter(comuna_scat,ptj_violencia,sentido_pertenencia,
            dot.labels = to_label(comuna_scat$comuna),
            fit.line = "lm",
            show.ci = TRUE,
            title = "Gráfico de dispersión para los promedios de Sentido de Pertenencia y ptj de Violencia agrupados por Comuna",
            axis.titles = c("Promedio de ptj de Violencia por Comuna","Promedio de Sentido de Pertenencia por Comuna"))

ggsave(scat_spb_pv,filename= "../3_output/graficos/scat_spb_pv.pdf")

scat_spb_pv
```

```{r Scatter SPB y Servicios Públicos}
scat_spb_serv <-
  plot_scatter(comuna_scat,servicios_publicos,sentido_pertenencia,
            dot.labels = to_label(comuna_scat$comuna),
            fit.line = "lm",
            show.ci = TRUE,
            title = "Gráfico de dispersión para los promedios de Sentido de Pertenencia y Acceso a Servicios Públicos agrupados por Comuna",
            axis.titles = c("Promedio Acceso a Servicios Públicos por Comuna","Promedio de Sentido de Pertenencia por Comuna"))

ggsave(scat_spb_serv,filename= "../3_output/graficos/scat_spb_serv.pdf")

scat_spb_serv
```

```{r Scatter SPB y Nivel de Densidad Poblacional, fig.height=600, fig.width=800, paged.print=FALSE}
scat_spb_dens <- 
  plot_scatter(comuna_scat,densidad,sentido_pertenencia,
            dot.labels = to_label(comuna_scat$comuna),
            fit.line = "lm",
            show.ci = TRUE,
            title = "Gráfico de dispersión para los promedios de Sentido de Pertenencia y Densidad Poblacional agrupados por Comuna",
            axis.titles = c("Promedio de Densidad Poblacional por Comuna","Promedio de Sentido de Pertenencia por Comuna"))

ggsave(scat_spb_dens,filename= "../3_output/graficos/scat_spb_dens.pdf")

scat_spb_dens
```

```{r Modelo de regresión multivariada}


```

```{r Modelo Nulo y RIFSM, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
#modelo nulo
model_0 = lmer(sentido_pertenencia ~ 1 + (1 | zona), data = elsoc_barrio)
0.11/(0.11+0.68) #calculo ICC
#0.139 -> 14%    #ICC 

#modelo con variables de control
model_1 =lmer(sentido_pertenencia ~ 1 + sexo + edad + (1 | zona), data = elsoc_barrio)
0.09/(0.09+0.66) #calculo ICC
#0.12 -> 12%    #ICC

#modelo con predictores individuales
model_2 = lmer(sentido_pertenencia ~ 1 + calidad_rrss + conf_vecinos + lazos + percep_inseguridad + exp_criminalidad + molestias_barrio + satisf_gobarrio + exp_gentrificacion + rep_barrial + (1 | zona), data = elsoc_barrio)
0.03/(0.03+0.41) #calculo ICC
#0.068 -> 6.8%   #ICC

#modelo con predictores contextuales
model_3 = lmer(sentido_pertenencia ~ 1 + nvl_esco + expo_hete + ptj_violencia + ptj_sustraccion + densidad + servicios_publicos + repbarrial_media_zonal + (1 | zona), data = elsoc_barrio)
0.02/(0.02+0.68) #calculo ICC
#0.028 -> 2.8%    #ICC

#modelo con predictores individuales y contextuales (multinivel)
model_4 = lmer(sentido_pertenencia ~ 1 + calidad_rrss + conf_vecinos + lazos + percep_inseguridad + exp_criminalidad + molestias_barrio + satisf_gobarrio + exp_gentrificacion + rep_barrial + nvl_esco + expo_hete + ptj_violencia + ptj_sustraccion + densidad + servicios_publicos + repbarrial_media_zonal + (1 | zona), data = elsoc_barrio)
0.02/(0.02+0.40) #calculo ICC
#0.047 -> 4.7%    #ICC

screenreg(list(model_0,model_1,model_2,model_3,model_4))
```

```{r Tabla de Modelo Nulo y RIFSM,eval=FALSE, include=FALSE, results='asis'}
#comparación gráfica de modelos
getwd()
htmlreg(list(model_0,model_2,model_3,model_4), file = "../output/tablas/rifsm_model.docx",
    custom.model.names = c("Modelo <br> Nulo","Modelo <br> Individual",
                           "Modelo <br> Contextual", "Modelo <br> Multinivel"),
    custom.coef.names = c("Intercepto","Satisfacción Barrial","Confianza en <br> Vecinos","Calidad RR.SS.",
                          "Economía Urbana","Reputación Barrial","Sentimiento <br> de Inseguridad",
                          "Densidad","ptj Violencia",
                          "ptj Sustracción","Servicios Públicos",
                          "Nivel Socioeconómico <br> (Proxy Escolaridad)",
                          "Exposición Heterogeneidad <br> Socioeconómica",
                          "Reputación Barrial Zonal "),
    caption="Modelos Multinivel para Sentido de Pertenencia al Barrio",
    caption.above=TRUE,
    digits=3)
```

```{r Tabla de Modelo Nulo y RIFSM,eval=FALSE, include=FALSE, results='asis'}
#comparación gráfica de modelos
htmlreg(list(model_0,model_2,model_3,model_4), file = "../3_output/tablas/rifsm_model.doc",
    digits=3)
```


```{r}
sessionInfo()
```
