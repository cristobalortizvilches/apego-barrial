---
title: "Código de Análisis de Datos"
output: html_document
---

```{r ajuste-markdown,include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = TRUE)
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
options(knitr.kable.NA = '')
```

```{r Cargar paquetes, include=FALSE}
library(tidyverse)
library(broom)
library(texreg)
library(stargazer)
library(MuMIn)
library(caret)
library(corrplot)
library(sjPlot)
```

```{r load-dataset-proc, include=FALSE}
rm(list=ls())
load("../1_input/data/procesada/elsoc.RData")
sapply(elsoc, class)
#View(elsoc)
```

```{r descriptivos-var}
stargazer(subset(elsoc, select = apbi:time), type = "text")
```

```{r validación-índices}
alpha_apbi <- alpha(dplyr::select(elsoc_gs, t02_01, t02_02, t02_03, t02_04)) 
#0.88
alpha_soci <- alpha(dplyr::select(elsoc_gs, t03_01, t03_02, t03_03, t03_04))
#0.81
alpha_cfli <- alpha(dplyr::select(elsoc_gs, t11_01, t11_02, t11_03, t11_04))
#0.67
alpha_acci <- alpha(dplyr::select(elsoc_gs, t06_02, t06_05, t06_06, t06_07))
#0,71
alpha_geni <- alpha(dplyr::select(elsoc_gs, t04_02, t04_03, t04_04))
#0.62
alpha_desi <- alpha(dplyr::select(elsoc_gs, t04_06, t04_07))
#0.71
```

```{r correlacion-var}
corr_elsoc <- elsoc %>% 
    select(apbi, soci, cnfi, cfli, acci, geni, desi, time) 

tab_corr(corr_elsoc, triangle = "lower", digits = 2)
```

```{r ajuste-modelos}
options(na.action = "na.omit")

#modelo con factores sociodemográficos
mod1 <- lm(apbi ~ sexo + edad + educ + essu + regi + time , data = elsoc)
#modelo con factores sociales
mod2 <- lm(apbi ~ soci + cnfi + segu + cfli, data = elsoc)
#modelo con factores físicos
mod3 <- lm(apbi ~ acci + geni, data = elsoc)
#modelo agrega factores simbólicos
mod4 <- lm(apbi ~ repb + desi, data = elsoc)
#modelo con factores sociodemográficos + sociales
mod5 <- lm(apbi ~ sexo + edad + educ + essu + regi + time + soci + cnfi + segu + cfli, data = elsoc)
#modelo con  factores sociodemográficos + sociales + físicos
mod6 <- lm(apbi ~ sexo + edad + educ + essu + regi + time + soci + cnfi + segu + cfli + acci + geni, data = elsoc)
#modelo con  factores sociodemográficos + sociales + físicos + simbólicos
mod7 <- lm(apbi ~ sexo + edad + educ + essu + regi + time + soci + cnfi + segu + cfli + acci + geni + repb + desi, data = elsoc)

screenreg(list(mod1,mod2,mod3,mod4,mod5,mod6,mod7))
```

```{r comparativa-modelos}
#comparativa modelos con MuMIn
models <- model.sel(list(mod1,mod2,mod3,mod4,mod5,mod6,mod7,mod8))
View(models)
```

```{r modelo-global}
elsoc_glob <- elsoc %>% 
    select(-idencuesta, -comuna, -comuna_cod, -apbr) %>% 
    drop_na()
modg <- lm(apbi ~ sexo + edad + educ + essu + regi + time + soci + cnfi + segu + cfli + acci + geni + repb + desi, data = elsoc_glob) #modelo general sin NA

options(na.action = "na.fail")

selected <- dredge(modg, m.lim = c(0, 15)) #itera combinaciones de modelos y rankea x AICc
View(selected)
subselected <- subset(selected, delta <= 2) #nos deja los mejores modelos (en este caso son 5)

bestmodel <- get.models(selected, 1)[[1]] #extrae el mejor modelo
screenreg(bestmodel)

#es lo mismo que:
#mod8 <- lm(apbi ~ time + soci + cnfi + segu + acci + geni + repb + desi, data = elsoc)
```
```{r Tabla modelo general }
htmlreg(list(mod1,mod2,mod3,mod4), file = "../3_output/tablas/int_model_cap1.doc",
    custom.model.names = c("Modelo 1","Modelo 2","Modelo 3", "Modelo 4"), #nombres modelos
    custom.coef.names = c("Intercepto","Mujer","30 a 49 años","50 a 64 años",">65 años", #sexo y edad
                          "Media","Técnica","Universitaria", "Clase Media","Clase Alta", #clase social
                          "No propietario", "Tiempo de residencia", #régimen viv y tiempo residencia
                          "Sociabilidad","Confianza en Vecinos","Ni seguro ni inseguro","Experiencia de seguridad","conflictividad vecinal", #dim social
                          "Satisfacción con Accesibilidad","Percepción de encarecimiento", #dim física
                          "Ni Estigmatizado Ni Prestigioso","Prestigioso","Deseabilidad Estilos de Vida"), #dim simbólica
    digits=2)
```

```{r Tabla modelo integral}
htmlreg(list(mod5), file = "../3_output/tablas/pars_model_cap1.doc",
    custom.model.names = c("Modelo Integral"), #nombres modelos
    custom.coef.names = c("Intercepto","Tiempo de residencia", # tiempo residencia
                          "Sociabilidad","Confianza en Vecinos","Ni seguro ni inseguro","Experiencia de seguridad", #dim social
                          "Satisfacción con Accesibilidad","Percepción de encarecimiento", #dim física
                          "Ni Estigmatizado Ni Prestigioso","Prestigioso","Deseabilidad Estilos de Vida"), #dim simbólica
    digits=2)
```

# Linealidad
```{r}
plot(bestmodel, 1)

#SE CUMPLE
```

# Normalidad de residuos

```{r}
plot(bestmodel, 2)

shapiro.test(bestmodel$residuals)

#SE CUMPLE
```
# Homocedasticidad

```{r}
plot(bestmodel, 3)

library(car)
ncvTest(bestmodel)

#install.packages("lmtest")
library(lmtest)
bptest(bestmodel)
#NO SE CUMPLE
```
# Multicolinealidad
```{r}
car::vif(bestmodel)

#SE CUMPLE
```
# Casos influyentes

```{r}
plot(bestmodel, 4)
plot(bestmodel, 5)

elsoc_sub <- elsoc %>% drop_na()
elsoc_sub$cook <- cooks.distance(bestmodel)
which(elsoc_sub$cook > 1)

#SE CUMPLE
```

```{r}
#sessionInfo()
```

